name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diffs
          
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          # âœ… Comprehensive cache key pattern (from UNIFIED_CI_APPROACH.md)
          key: ${{ runner.os }}-pip-${{ hashFiles('**/*requirements*.txt', '**/pyproject.toml', '**/setup.py', '**/setup.cfg') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # âœ… Pin tool versions (from UNIFIED_CI_APPROACH.md)
          pip install pre-commit pytest pytest-cov ruff==0.5.0 mypy==1.10.0 black==24.4.2
          if [ -f python/requirements.txt ]; then pip install -r python/requirements.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Run quality check
        id: quality-check
        run: |
          # âœ… Check both possible script locations (quality_check.py is the actual file name)
          if [ -f scripts/quality_check.py ]; then
            python scripts/quality_check.py || exit 1
          elif [ -f scripts/quality-check.py ]; then
            python scripts/quality-check.py || exit 1
          elif [ -f quality_check_script.py ]; then
            python quality_check_script.py || exit 1
          else
            echo "âš ï¸ Warning: No quality check script found, skipping..."
          fi
          
      - name: Check for placeholders
        id: placeholders
        run: |
          # Fail if TODO, FIXME, or other placeholders found in Python files
          # Exclude scripts directory as it legitimately contains these terms
          if grep -r "TODO\|FIXME\|XXX\|HACK\|pass #\|\.\.\..*#\|NotImplementedError" \
            --include="*.py" \
            --exclude-dir=".git" \
            --exclude-dir="archive" \
            --exclude-dir="legacy" \
            --exclude-dir="experimental" \
            --exclude-dir="scripts" .; then
            echo "âŒ ERROR: Placeholders found in code"
            exit 1
          else
            echo "âœ… No placeholders found"
          fi
            
      - name: Check for magic numbers
        id: magic-numbers
        run: |
          # Check for common magic numbers that should be constants
          if grep -r "[^0-9a-zA-Z_]3\.14[0-9]*\|9\.8[0-9]*\|6\.67[0-9]*\|2\.71[0-9]*" \
            --include="*.py" \
            --exclude-dir=".git" \
            --exclude-dir="tests" .; then
            echo "âš ï¸ WARNING: Possible magic numbers found (should be named constants with sources)"
            echo "Examples: 3.14â†’math.pi, 9.8â†’GRAVITY_M_S2, 2.71â†’math.e"
          else
            echo "âœ… No obvious magic numbers found"
          fi
          
      - name: Check for approximations
        id: approximations
        run: |
          # Fail if "approximately" or similar found
          if grep -ri "approximately\|approx[^a-z]\|roughly\|~[0-9]" \
            --include="*.py" --include="*.m" \
            --exclude-dir=".git" \
            --exclude-dir="docs" .; then
            echo "âŒ ERROR: Approximations found - use exact values with sources"
            exit 1
          else
            echo "âœ… No approximations found"
          fi
            
      - name: Run pre-commit
        id: pre-commit
        run: |
          pre-commit run --all-files --show-diff-on-failure || exit 1
          
      - name: Format check with Black
        id: black
        run: |
          echo "ðŸ” Checking code formatting with Black..."
          # âœ… Check source directories explicitly
          if [ -d python/src ]; then
            if [ -d python/tests ]; then
              black --check --diff python/src python/tests || exit 1
            else
              black --check --diff python/src || exit 1
            fi
          elif [ -d python ]; then
            black --check --diff python || exit 1
          elif [ -d src ]; then
            if [ -d tests ]; then
              black --check --diff src tests/ || exit 1
            else
              black --check --diff src || exit 1
            fi
          else
            black --check --diff . || exit 1
          fi
          
      - name: Run strict type checking
        id: mypy
        run: |
          if find . -name "*.py" -not -path "./archive/*" -not -path "./legacy/*" -not -path "./games/*" | head -n1 | grep -q .; then
            if [ -f mypy.ini ]; then
              mypy . --config-file mypy.ini || exit 1
            else
              mypy . --strict --ignore-missing-imports || exit 1
            fi
          else
            echo "No Python files to type check"
          fi
          
      - name: Run tests with coverage
        id: tests
        run: |
          if [ -d python/tests ] || [ -d tests ]; then
            pytest -xvs --cov=python --cov-report=term-missing --cov-fail-under=60 || {
              echo "âŒ Tests failed or coverage below 60%"
              exit 1
            }
          else
            echo "âš ï¸ WARNING: No tests directory found - ADD TESTS!"
          fi
          
      - name: Verify reproducibility
        run: |
          # Check that random seeds are set in Python files using randomness
          echo "Checking for unseeded randomness..."
          for file in $(find . -name "*.py" -type f -not -path "./archive/*" -not -path "./legacy/*"); do
            if grep -q "np\.random\|random\.\|torch\." "$file" 2>/dev/null; then
              if ! grep -q "seed\|random_state\|generator" "$file"; then
                echo "âš ï¸ Warning: $file uses randomness without visible seed"
              fi
            fi
          done
          
      - name: Check for required constants documentation
        run: |
          # Verify physical constants have units and sources
          echo "Checking constants documentation..."
          for file in $(find . -name "*.py" -type f -not -path "./tests/*" -not -path "./archive/*"); do
            if grep -q "GRAVITY\|MASS\|DENSITY\|COEFFICIENT" "$file" 2>/dev/null; then
              if ! grep -q "\[.*\].*#\|#.*\[.*\]" "$file"; then
                echo "âš ï¸ Warning: $file may have undocumented constants (need units + source)"
              fi
            fi
          done
          
      - name: Summary
        if: always()
        run: |
          echo "### CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Quality Check
          if [ "${{ steps.quality-check.outcome }}" == "success" ] || [ "${{ steps.quality-check.outcome }}" == "skipped" ]; then
            echo "| Quality Check | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Quality Check | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Placeholders
          if [ "${{ steps.placeholders.outcome }}" == "success" ] || [ "${{ steps.placeholders.outcome }}" == "skipped" ]; then
            echo "| No Placeholders | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| No Placeholders | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Magic Numbers
          if [ "${{ steps.magic-numbers.outcome }}" == "success" ] || [ "${{ steps.magic-numbers.outcome }}" == "skipped" ]; then
            echo "| No Magic Numbers | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| No Magic Numbers | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Approximations
          if [ "${{ steps.approximations.outcome }}" == "success" ] || [ "${{ steps.approximations.outcome }}" == "skipped" ]; then
            echo "| No Approximations | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| No Approximations | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Pre-commit (non-blocking)
          if [ "${{ steps.pre-commit.outcome }}" == "success" ] || [ "${{ steps.pre-commit.outcome }}" == "skipped" ]; then
            echo "| Pre-commit | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pre-commit | âš ï¸ (non-blocking) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Black
          if [ "${{ steps.black.outcome }}" == "success" ] || [ "${{ steps.black.outcome }}" == "skipped" ]; then
            echo "| Black Formatting | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Black Formatting | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # MyPy Type Checking
          if [ "${{ steps.mypy.outcome }}" == "success" ] || [ "${{ steps.mypy.outcome }}" == "skipped" ]; then
            echo "| MyPy Type Checking | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MyPy Type Checking | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Tests
          if [ "${{ steps.tests.outcome }}" == "success" ] || [ "${{ steps.tests.outcome }}" == "skipped" ]; then
            echo "| Tests + Coverage | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Tests + Coverage | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
  matlab-analysis:
    runs-on: ubuntu-latest
    if: false  # Enable when MATLAB runner available
    steps:
      - uses: actions/checkout@v4
      - uses: matlab-actions/setup-matlab@v2
      - uses: matlab-actions/run-command@v2
        with:
          command: |
            % Add paths
            addpath(genpath('matlab'));
            
            % Check for magic numbers in MATLAB
            mFiles = dir('**/*.m');
            for i = 1:length(mFiles)
                content = fileread(fullfile(mFiles(i).folder, mFiles(i).name));
                if contains(content, {'3.14', '9.8', '6.67'})
                    warning('Possible magic number in %s', mFiles(i).name);
                end
            end
            
            % Run tests
            results = runtests('matlab/tests');
            assertSuccess(results);

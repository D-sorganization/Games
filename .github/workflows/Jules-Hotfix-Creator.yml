name: Jules Hotfix-Creator (Worker)

# Triggers when CI fails on protected branches (main/master)
# Creates a hotfix branch, triggers Auto-Repair, and opens urgent PR

on:
  workflow_call:
    inputs:
      run_id:
        required: true
        type: string
      failed_branch:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  create-hotfix:
    runs-on: ubuntu-latest
    # Only run for trusted branches (main/master)
    if: inputs.failed_branch == 'main' || inputs.failed_branch == 'master'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.failed_branch }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm install -g @google/jules
      - run: jules auth --token ${{ secrets.JULES_API_KEY }}

      - name: Create Hotfix Branch
        id: hotfix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          HOTFIX_BRANCH="hotfix/ci-fail-${TIMESTAMP}"

          echo "Creating hotfix branch: $HOTFIX_BRANCH"
          git checkout -b "$HOTFIX_BRANCH"
          git push -u origin "$HOTFIX_BRANCH"

          echo "branch=$HOTFIX_BRANCH" >> $GITHUB_OUTPUT

      - name: Fetch CI Logs & Auto-Fix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_RUN_ID: ${{ inputs.run_id }}
          FAILED_BRANCH: ${{ inputs.failed_branch }}
          HOTFIX_BRANCH: ${{ steps.hotfix.outputs.branch }}
        run: |
          gh run view "$TARGET_RUN_ID" --log-failed > logs.txt

          LOG_CONTENT=$(cat logs.txt)
          PROMPT="URGENT: CI failed on protected branch ${FAILED_BRANCH}.
          Analyze the logs and create a minimal hotfix:
          1. **Formatting & Linting**: Run 'ruff check . --fix' and 'black .'
          2. **Import Sorting**: Run 'isort --profile black .'
          3. **Type Errors**: Add missing type hints or proper type ignores
          4. **Test Failures**: Fix failing tests (fix implementation, not tests)
          5. **Coverage**: Generate tests if coverage dropped below 80%
          6. **Syntax**: Fix any syntax errors or missing imports
          CRITICAL: This is a hotfix for ${FAILED_BRANCH}. Keep changes minimal and focused.
          CI Failure Logs:
          $LOG_CONTENT"
          jules task fix --branch "$HOTFIX_BRANCH" --prompt "$PROMPT"

      - name: Create Urgent PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAILED_BRANCH: ${{ inputs.failed_branch }}
          HOTFIX_BRANCH: ${{ steps.hotfix.outputs.branch }}
          RUN_ID: ${{ inputs.run_id }}
          SERVER_URL: ${{ github.server_url }}
          REPO: ${{ github.repository }}
        run: |
          gh pr create \
            --base "$FAILED_BRANCH" \
            --head "$HOTFIX_BRANCH" \
            --title "ðŸš¨ Urgent: Fix CI failure on ${FAILED_BRANCH}" \
            --label "urgent,auto-fix,hotfix" \
            --body "## ðŸš¨ Automated Hotfix for Protected Branch

            **Failed Branch:** \`${FAILED_BRANCH}\`
            **CI Run:** ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}
            **Created By:** Jules Hotfix-Creator

            ### Summary
            CI failed on the protected branch \`${FAILED_BRANCH}\`. This automated hotfix attempts to resolve the issues.

            ### Changes
            Jules Auto-Repair has analyzed the CI failure logs and applied fixes for:
            - Code formatting and linting issues
            - Type checking errors
            - Test failures
            - Coverage gaps
            - Syntax errors

            ### Review Checklist
            - [ ] Verify all CI checks pass
            - [ ] Review changes are minimal and focused
            - [ ] Confirm no unintended side effects
            - [ ] Merge immediately if changes look correct

            ### Next Steps
            1. Review the changes in this PR
            2. If acceptable, merge immediately to restore ${FAILED_BRANCH}
            3. If issues remain, manually fix and push to this branch

            ---
            *This is an automated hotfix. Please review carefully before merging.*"

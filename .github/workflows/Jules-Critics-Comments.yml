name: Jules Critics Comments Writer (Worker)

# Reviews code with a critical eye, providing constructive feedback
# Identifies areas for improvement from a code reviewer's perspective

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      severity_threshold:
        description: 'Minimum severity to report'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: jules-critics-comments-${{ github.repository }}
  cancel-in-progress: false

jobs:
  critical-review:
    name: Critical Code Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Analysis Tools
        run: |
          pip install pylint radon vulture 2>/dev/null || true

      - name: Perform Critical Analysis
        id: analyze
        env:
          SEVERITY_THRESHOLD: ${{ inputs.severity_threshold || 'medium' }}
        run: |
          DATE=$(date +%Y-%m-%d)
          REPORT_DIR="docs/assessments/critics"
          mkdir -p "$REPORT_DIR"

          REPORT_FILE="$REPORT_DIR/review_${DATE}.md"

          echo "# Critical Code Review - $DATE" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "This report provides constructive criticism for code improvement." >> "$REPORT_FILE"
          echo "**Severity Threshold**: $SEVERITY_THRESHOLD" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Set radon complexity grade filter based on severity threshold
          # low = all grades (A-F), medium = B-F, high = C-F
          case "$SEVERITY_THRESHOLD" in
            low)
              RADON_GRADE="A"
              VULTURE_CONFIDENCE=60
              ;;
            high)
              RADON_GRADE="C"
              VULTURE_CONFIDENCE=90
              ;;
            *)  # medium (default)
              RADON_GRADE="B"
              VULTURE_CONFIDENCE=80
              ;;
          esac

          # Code Complexity Analysis
          echo "## Complexity Analysis" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          if command -v radon &> /dev/null; then
            echo '```' >> "$REPORT_FILE"
            radon cc . -a -s --exclude ".venv,archive,__pycache__" -n"$RADON_GRADE" 2>/dev/null | head -50 >> "$REPORT_FILE" || echo "No complexity issues found" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
          else
            echo "*Radon not available for complexity analysis*" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # Dead Code Detection
          echo "## Potential Dead Code" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          if command -v vulture &> /dev/null; then
            echo '```' >> "$REPORT_FILE"
            vulture . --exclude ".venv,archive,__pycache__" --min-confidence "$VULTURE_CONFIDENCE" 2>/dev/null | head -30 >> "$REPORT_FILE" || echo "No dead code found" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
          else
            echo "*Vulture not available for dead code detection*" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"

          # Large Files
          echo "## Large Files (potential refactoring candidates)" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "| File | Lines |" >> "$REPORT_FILE"
          echo "|------|-------|" >> "$REPORT_FILE"
          find . -name "*.py" -not -path "./.venv/*" -not -path "./archive/*" -exec wc -l {} \; 2>/dev/null | \
            sort -rn | head -10 | awk '{print "| " $2 " | " $1 " |"}' >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Long Functions (basic heuristic)
          echo "## Functions Over 50 Lines" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "Consider breaking these into smaller functions:" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Simple grep for long function bodies
          grep -rn "^def " --include="*.py" --exclude-dir=.venv --exclude-dir=archive . 2>/dev/null | head -20 >> "$REPORT_FILE" || echo "Analysis complete" >> "$REPORT_FILE"

          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "*Generated by Jules Critics Comments Writer*" >> "$REPORT_FILE"

          echo "report_path=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Commit Report
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(review): critical analysis"
          file_pattern: "docs/assessments/critics/*"

      - name: Summary
        run: |
          echo "## Jules Critics Comments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Critical analysis completed." >> $GITHUB_STEP_SUMMARY
          echo "Report: ${{ steps.analyze.outputs.report_path }}" >> $GITHUB_STEP_SUMMARY

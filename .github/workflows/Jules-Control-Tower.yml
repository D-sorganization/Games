name: Jules Control Tower

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, closed]
  workflow_run:
    workflows: ["CI Standard"]
    types: [completed]
  schedule:
    # RELAXED WEEKLY SCHEDULE - Games is a fun side project (Tier 3)
    - cron: "0 2 * * 0"   # Sunday 2 AM - Weekly assessment
    - cron: "0 5 * * 1"   # Monday 5 AM - Security check

concurrency:
  group: jules-control-tower
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  triage:
    runs-on: ubuntu-latest
    if: github.actor != 'jules-bot'
    outputs:
      target: ${{ steps.decide.outputs.target }}
    steps:
      - name: Analyze Event Context
        id: decide
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            let target = "none";

            // 1. CI FAILURE -> AUTO-REPAIR
            if (event === "workflow_run" && context.payload.workflow_run.conclusion === "failure") {
               const failedBranch = context.payload.workflow_run.head_branch;
               if (failedBranch === "main" || failedBranch === "master") {
                  target = "hotfix-creator";
               } else {
                  target = "auto-repair";
               }
            }
            // 2. WEEKLY SCHEDULE - Minimal maintenance
            else if (event === "schedule") {
              const day = new Date().getDay();
              if (day === 0) { // Sunday
                 target = "assessment-generator";
              } else if (day === 1) { // Monday
                 target = "sentinel";
              }
            }
            // 3. PUSH TO MAIN -> Skip docs for games
            // 4. NEW PR -> TEST GENERATOR (keep this)
            else if (event === "pull_request" && context.payload.action === 'opened') {
               target = "test-generator";
            }
            // 5. PR CLOSED -> Skip archivist for games

            console.log(`Decision: Dispatching [${target}]`);
            core.setOutput("target", target);

  # --- WORKER DISPATCH (Minimal for side project) ---

  call-repair:
    needs: triage
    if: needs.triage.outputs.target == 'auto-repair'
    uses: ./.github/workflows/Jules-Auto-Repair.yml
    with:
      run_id: ${{ github.event.workflow_run.id }}
      branch: ${{ github.event.workflow_run.head_branch }}
    secrets: inherit

  call-hotfix-creator:
    needs: triage
    if: needs.triage.outputs.target == 'hotfix-creator'
    uses: ./.github/workflows/Jules-Hotfix-Creator.yml
    with:
      run_id: ${{ github.event.workflow_run.id }}
      failed_branch: ${{ github.event.workflow_run.head_branch }}
    secrets: inherit

  call-tests:
    needs: triage
    if: needs.triage.outputs.target == 'test-generator'
    uses: ./.github/workflows/Jules-Test-Generator.yml
    secrets: inherit

  call-sentinel:
    needs: triage
    if: needs.triage.outputs.target == 'sentinel'
    uses: ./.github/workflows/Jules-Sentinel.yml
    secrets: inherit

  call-assessment-generator:
    needs: triage
    if: needs.triage.outputs.target == 'assessment-generator'
    uses: ./.github/workflows/Jules-Assessment-Generator.yml
    secrets: inherit
